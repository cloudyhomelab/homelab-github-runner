name: build and push github runner image

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  REGISTRY: docker.io

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: login to docker hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: set up docker buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: build and push
        id: bake
        uses: docker/bake-action@v6
        with:
          targets: image-all
          push: true
          set: |
            *.attest=type=provenance,mode=max
            *.attest=type=sbom

      - name: install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: sign published image(s) (keyless)
        env:
          BAKE_METADATA: ${{ steps.bake.outputs.metadata }}
        run: |
          set -euo pipefail
          echo "${BAKE_METADATA}" > bake-metadata.json

          # Extract tag@digest refs from Bake metadata and sign them.
          jq -r '
            to_entries[]
            | .value as $v
            | ($v["containerimage.digest"] // empty) as $digest
            | ($v["image.name"] // empty) as $names
            | if ($digest == "" or $names == "") then empty else
                (if ($names|type) == "string" then ($names|split(",")) else $names end)
                | map(gsub("^\\s+|\\s+$"; ""))
                | map(select(length>0))
                | .[]
                | "\(. )@\($digest)"
              end
          ' bake-metadata.json | sort -u | while read -r ref; do
            echo "Signing ${ref}"
            cosign sign --yes "${ref}"
          done
